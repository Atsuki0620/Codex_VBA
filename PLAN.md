# Notebook 実装計画

## 概要
- 任意の `.xlsm` から VBA モジュールを高速エクスポートし、Azure OpenAI を活用した要約・関係性推定・最終レポートを生成する Jupyter Notebook を新規作成する。
- `export_vba_modules_ja_ai_report.ipynb` を参考としつつ、汎用的に動作するよう設計する。
- Azure OpenAI の API キーやエンドポイントなどの秘匿情報は本リポジトリや共有環境には置かず、利用者の実行環境で `.env` 等に設定して実行することを前提とする。

## ゴール
- `.xlsm` 内の VBA モジュールを `.bas/.cls/.frm(+.frx)` とマニフェストとして高速に書き出す。
- `.env` からプロキシ・キー・エンドポイント・バージョンを読み込み、Azure OpenAI との接続を確立する。
- エクスポートした各ファイルの機能、主要処理、イベント、外部依存、改善点を日本語で要約する。
- モジュールと主要プロシージャの一覧をもとに Mermaid シーケンス図を生成する。
- すべての要約とシーケンス図を集約した Markdown レポートを作成する。

## 非ゴール
- VBA コードの完全な静的解析や呼び出し関係の網羅的算出。
- Azure OpenAI 以外の LLM サービスとの自動連携やモデル切り替え。
- エクスポートした VBA の修正・再インポート、自動リファクタリング。
- Excel シートデータ解析やレポート生成以外のデータ処理。
- 大規模分散処理やジョブキューによるスケーリング。
- VBA の外部依存や危険箇所、改善点などの改善提案を自動で導き出すこと。

## エラーハンドリング方針
- Excel COM 操作で例外発生時でも、`Workbook.Close` と `Application.Quit` を確実に実施し、インスタンスをリークさせない。
- ファイル読み込み時は文字コードエラーなどを検出し、代替テキストや警告を残して処理を継続する。
- `.env` 未設定や必須キー欠如時には事前検証で明示的に停止し、補足説明を表示する。
- Azure OpenAI 呼び出し失敗時はエラーメッセージを保持しつつ処理を継続し、最終レポートに反映する。
- Mermaid 図生成が失敗した場合は代替メッセージを出力し、レポート生成を止めない。

## テスト戦略
- **手動テスト**：`TKA01_companycal_and_easysche.ver.1.0.0.xlsm` を用いたエンドツーエンド実行で成果物一式を確認する。
- **汎用性確認**：構造の異なる `.xlsm` を複数用意し、同様のフローで実行して成功することを検証する。
- **異常系テスト**：`.env` 欠如、Azure OpenAI API エラー、ファイル読み込み失敗などのケースで期待通りのエラー処理が行われることを確認する。
- **レビュー**：各セルに説明マークダウンとコメントが存在し、`AGENTS.md` の規約に沿っているかを静的に確認する。

## WBS
1. **準備**
   - 既存ノートブックを参照し、必要なライブラリと処理手順を整理する。
   - 新規ノートブックの雛形を作成し、日本語マークダウンとコメント方針を適用する。
2. **VBA エクスポート機能**
   - Excel COM を介した `.xlsm` の読み込みと VBA モジュール高速エクスポート処理を実装する。
   - マニフェストファイルや出力フォルダ構成を整備する。
3. **環境設定セル**
   - `.env` からの設定読み込み、プロキシ設定、Azure OpenAI クライアント初期化処理を実装する。
   - 認証情報検証と例外処理を追加する。
4. **要約処理セル**
   - エクスポート済みファイルを読み込み、主要情報抽出（プロシージャ名など）と LLM への要約依頼処理を実装する。
   - 要約結果の保存、ログ出力、エラー時のフォールバックを整備する。
5. **関係性推定セル**
   - モジュール一覧と主要プロシージャの情報を整形し、Mermaid シーケンス図生成を行う。
   - 生成失敗時のプレースホルダーメッセージを定義する。
6. **最終レポート生成セル**
   - 要約一覧とシーケンス図を統合した Markdown レポートを組み立てる処理を実装する。
   - ファイル保存、目次、ログ出力を含めて検証する。
7. **検証とドキュメント整備**
   - サンプル `.xlsm` を用いた手動テスト結果を確認し、必要に応じて調整する。
   - `AGENTS.md` と `PLAN.md` を最終更新し、利用上の注意を追記する。
